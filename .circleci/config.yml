version: 2.1

jobs:

  integration-postgres:
    docker:
      - image: cimg/python:3.9.9
      - image: cimg/postgres:14.0

    environment:
      DBT_PROFILES_DIR: ./
      DBT_PROJECT_DIR: ./integration_tests

    steps:
      - checkout
      - run:
          name: Install Python packages
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install -U pip wheel
            pip install dbt-core dbt-postgres dbt-bigquery dbt-snowflake

      - run:
          name: Install dbt dependencies
          command: |
            . venv/bin/activate
              dbt deps --project-dir $DBT_PROJECT_DIR

      - run:
          name: "Run Tests - Postgres"
          environment:
            POSTGRES_TEST_HOST: localhost
            POSTGRES_TEST_USER: root
            POSTGRES_TEST_PASS: ''
            POSTGRES_TEST_PORT: 5432
            POSTGRES_TEST_DBNAME: postgres
          command: |
            . venv/bin/activate
            dbt build -t postgres --project-dir $DBT_PROJECT_DIR

      - store_artifacts:
          path: ./logs

workflows:
  version: 2
  test-all:
    jobs:
      - integration-postgres
